/home/nakagawa/compare_method/original/Animal-CLIP/clip/clip.py:6: UserWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html. The pkg_resources package is slated for removal as early as 2025-11-30. Refrain from using this package or pin to Setuptools<81.
  from pkg_resources import packaging
Disabling PyTorch because PyTorch >= 2.1 is required but found 1.13.0+cu116
None of PyTorch, TensorFlow >= 2.0, or Flax have been found. Models won't be available and only tokenizers, configuration and file/data utilities can be used.
=> merge config from configs/mmnet/XCLIP-16-8.yaml
RANK and WORLD_SIZE in environ: 0/1
[2025-10-18 10:21:49 ViT-B/16](main.py 249): INFO working dir: exp
[2025-10-18 10:21:49 ViT-B/16](main.py 253): INFO AUG:
  COLOR_JITTER: 0.8
  CUTMIX: 1.0
  GRAY_SCALE: 0.2
  LABEL_SMOOTH: 0.1
  MIXUP: 0.8
  MIXUP_SWITCH_PROB: 0.5
BASE: ['']
BN:
  NORM_TYPE: batchnorm
  NUM_BATCHES_PRECISE: 200
  NUM_SPLITS: 1
  NUM_SYNC_DEVICES: 1
  USE_PRECISE_STATS: False
  WEIGHT_DECAY: 0.0
DATA:
  ANIMAL_LABEL_LIST: /mnt/nfs/mammal_net/annotation/genus_to_id.txt
  CLASSES: None
  DATASET: mmnet
  FEATURE_ROOT: None
  INPUT_CHANNEL_NUM: []
  INPUT_SIZE: 224
  LABEL_LIST: /mnt/nfs/mammal_net/annotation/behavior_to_id.txt
  MULTI_CLASSES: False
  NUM_ANIMAL_CLASSES: 173
  NUM_CLASSES: 12
  NUM_FRAMES: 8
  RELATION_FILE: /mnt/nfs/mammal_net/annotation/composition/relation.txt
  ROOT: /mnt/nfs/mammal_net/
  TRAIN_FILE: /mnt/nfs/mammal_net/annotation/composition/train.csv
  VAL_FILE: /mnt/nfs/mammal_net/annotation/composition/test.csv
  animal_description: None
  description: None
LOCAL_RANK: -1
MODEL:
  ARCH: ViT-B/16
  CONVERT_FROM_CAFFE2: False
  DROPCONNECT_RATE: 0.0
  DROPOUT_RATE: 0.5
  DROP_PATH_RATE: 0.0
  FC_INIT_STD: 0.01
  FIX_TEXT: True
  HEAD_ACT: softmax
  MODEL_NAME: XCLIP
  MULTI_PATHWAY_ARCH: ['slowfast']
  PRETRAINED: None
  RESUME: /mnt/nfs/mammal_net/models/Animal-CLIP/mmnet_best.pth
  SINGLE_PATHWAY_ARCH: ['2d', 'c2d', 'i3d', 'slow', 'x3d', 'mvit', 'xclip', 'ViT-B/16', 'ViT-B/32', 'ViT-L/14']
MULTIGRID:
  SHORT_CYCLE: False
MVIT:
  CLS_EMBED_ON: True
  DEPTH: 16
  DIM_MUL: []
  DROPOUT_RATE: 0.0
  DROPPATH_RATE: 0.1
  EMBED_DIM: 96
  HEAD_MUL: []
  MLP_RATIO: 4.0
  MODE: conv
  NORM: layernorm
  NORM_STEM: False
  NUM_HEADS: 1
  PATCH_2D: False
  PATCH_KERNEL: [3, 7, 7]
  PATCH_PADDING: [2, 4, 4]
  PATCH_STRIDE: [2, 4, 4]
  POOL_KV_KERNEL: [[]]
  POOL_KV_STRIDE: [[]]
  POOL_Q_KERNEL: [[]]
  POOL_Q_STRIDE: [[]]
  POOL_SKIP_KERNEL: [[]]
  POOL_SKIP_STRIDE: [[]]
  QKV_BIAS: True
  SEP_POS_EMBED: False
  ZERO_DECAY_POS_CLS: True
NONLOCAL:
  GROUP: [[1], [1], [1], [1]]
  INSTANTIATION: dot_product
  LOCATION: [[[]], [[]], [[]], [[]]]
  POOL: [[[1, 2, 2], [1, 2, 2]], [[1, 2, 2], [1, 2, 2]], [[1, 2, 2], [1, 2, 2]], [[1, 2, 2], [1, 2, 2]]]
NUM_SHARDS: 1
NUM_WORKERS: 16
OUTPUT: exp
PRED: False
PRINT_FREQ: 50
RESNET:
  DEPTH: 50
  INPLACE_RELU: True
  NUM_BLOCK_TEMP_KERNEL: [[3], [4], [6], [3]]
  NUM_GROUPS: 1
  SPATIAL_DILATIONS: [[1], [1], [1], [1]]
  SPATIAL_STRIDES: [[1], [2], [2], [2]]
  STRIDE_1X1: False
  TRANS_FUNC: bottleneck_transform
  WIDTH_PER_GROUP: 64
  ZERO_INIT_FINAL_BN: False
SAVE_FREQ: 1
SEED: 1024
SLOWFAST:
  ALPHA: 8
  BETA_INV: 8
  FUSION_CONV_CHANNEL_RATIO: 2
  FUSION_KERNEL_SZ: 5
TEST:
  NUM_CLIP: 1
  NUM_CROP: 1
  ONLY_TEST: True
  TEST_LONG_TAIL: True
  TSNE: False
TRAIN:
  ACCUMULATION_STEPS: 4
  AUTO_RESUME: False
  BASE_LR_SCALE_NUM_SHARDS: False
  BATCH_SIZE: 16
  DAMPENING: 0.0
  EPOCHS: 30
  LOSS: ce
  LR: 8e-06
  LRS: []
  LR_POLICY: cosine
  MOMENTUM: 0.9
  NESTEROV: True
  OPTIMIZER: adamw
  OPT_LEVEL: O1
  STEPS: []
  USE_CHECKPOINT: False
  WARMUP_EPOCHS: 5.0
  WEIGHT_DECAY: 0.001
  WEIGHT_DECAY_STEPS: 200000.0
  ZERO_WD_1D_PARAM: False
X3D:
  BN_LIN5: False
  BOTTLENECK_FACTOR: 1.0
  CHANNELWISE_3x3x3: True
  DEPTH_FACTOR: 1.0
  DIM_C1: 12
  DIM_C5: 2048
  SCALE_RES2: False
  WIDTH_FACTOR: 1.0
Building DataLoader
########### loading data ##########
########### train data loaded ############
########### loading data ##########
########### val data loaded ############
Building ModelBuilder
[2025-10-18 10:21:55 ViT-B/16](tools.py 337): INFO Loading network weights from /mnt/nfs/mammal_net/models/Animal-CLIP/mmnet_best.pth.
533
[2025-10-18 10:21:57 ViT-B/16](tools.py 586): INFO graph.layers.1.norm.weight torch.Size([256]) -> torch.Size([512])
[2025-10-18 10:21:57 ViT-B/16](tools.py 586): INFO graph.layers.1.norm.bias torch.Size([256]) -> torch.Size([512])
504
[2025-10-18 10:21:57 ViT-B/16](tools.py 491): INFO Network weights graph.layers.1.weight not loaded.
[2025-10-18 10:21:57 ViT-B/16](tools.py 523): INFO => loaded successfully '/mnt/nfs/mammal_net/models/Animal-CLIP/mmnet_best.pth' (epoch 28)
torch.Size([12, 77])
torch.Size([173, 77])
[2025-10-18 10:22:01 ViT-B/16](val.py 72): INFO 1 views inference
Traceback (most recent call last):
  File "/home/nakagawa/compare_method/original/Animal-CLIP/main.py", line 256, in <module>
    main(config)
  File "/home/nakagawa/compare_method/original/Animal-CLIP/main.py", line 185, in main
    map, acc1  = val.validate(val_loader, val_data, text_labels, animal_labels, model, config, logger, vis=False)
  File "/home/nakagawa/compare_method/original/Animal-CLIP/.venv/lib/python3.9/site-packages/torch/autograd/grad_mode.py", line 27, in decorate_context
    return func(*args, **kwargs)
  File "/home/nakagawa/compare_method/original/Animal-CLIP/val.py", line 106, in validate
    output, vf = model(image_input, text_inputs, animal_labels, animal_pred, edges, filename, config.PRED) # + output
  File "/home/nakagawa/compare_method/original/Animal-CLIP/.venv/lib/python3.9/site-packages/torch/nn/modules/module.py", line 1190, in _call_impl
    return forward_call(*input, **kwargs)
  File "/home/nakagawa/compare_method/original/Animal-CLIP/.venv/lib/python3.9/site-packages/torch/nn/parallel/distributed.py", line 1040, in forward
    output = self._run_ddp_forward(*inputs, **kwargs)
  File "/home/nakagawa/compare_method/original/Animal-CLIP/.venv/lib/python3.9/site-packages/torch/nn/parallel/distributed.py", line 993, in _run_ddp_forward
    inputs, kwargs = _to_kwargs(
  File "/home/nakagawa/compare_method/original/Animal-CLIP/.venv/lib/python3.9/site-packages/torch/distributed/utils.py", line 94, in _to_kwargs
    _recursive_to(inputs, device_id, use_side_stream_for_tensor_copies)
  File "/home/nakagawa/compare_method/original/Animal-CLIP/.venv/lib/python3.9/site-packages/torch/distributed/utils.py", line 86, in _recursive_to
    res = to_map(inputs)
  File "/home/nakagawa/compare_method/original/Animal-CLIP/.venv/lib/python3.9/site-packages/torch/distributed/utils.py", line 77, in to_map
    return list(zip(*map(to_map, obj)))
  File "/home/nakagawa/compare_method/original/Animal-CLIP/.venv/lib/python3.9/site-packages/torch/distributed/utils.py", line 55, in to_map
    if obj.device == torch.device("cuda", target_gpu):
RuntimeError: Device index must not be negative
ERROR:torch.distributed.elastic.multiprocessing.api:failed (exitcode: 1) local_rank: 0 (pid: 741544) of binary: /home/nakagawa/compare_method/original/Animal-CLIP/.venv/bin/python3
Traceback (most recent call last):
  File "/home/nakagawa/compare_method/original/Animal-CLIP/.venv/bin/torchrun", line 7, in <module>
    sys.exit(main())
  File "/home/nakagawa/compare_method/original/Animal-CLIP/.venv/lib/python3.9/site-packages/torch/distributed/elastic/multiprocessing/errors/__init__.py", line 346, in wrapper
    return f(*args, **kwargs)
  File "/home/nakagawa/compare_method/original/Animal-CLIP/.venv/lib/python3.9/site-packages/torch/distributed/run.py", line 762, in main
    run(args)
  File "/home/nakagawa/compare_method/original/Animal-CLIP/.venv/lib/python3.9/site-packages/torch/distributed/run.py", line 753, in run
    elastic_launch(
  File "/home/nakagawa/compare_method/original/Animal-CLIP/.venv/lib/python3.9/site-packages/torch/distributed/launcher/api.py", line 132, in __call__
    return launch_agent(self._config, self._entrypoint, list(args))
  File "/home/nakagawa/compare_method/original/Animal-CLIP/.venv/lib/python3.9/site-packages/torch/distributed/launcher/api.py", line 246, in launch_agent
    raise ChildFailedError(
torch.distributed.elastic.multiprocessing.errors.ChildFailedError: 
============================================================
main.py FAILED
------------------------------------------------------------
Failures:
  <NO_OTHER_FAILURES>
------------------------------------------------------------
Root Cause (first observed failure):
[0]:
  time      : 2025-10-18_10:22:08
  host      : biogpu
  rank      : 0 (local_rank: 0)
  exitcode  : 1 (pid: 741544)
  error_file: <N/A>
  traceback : To enable traceback see: https://pytorch.org/docs/stable/elastic/errors.html
============================================================
